{% extends "base.html" %}

{% block title %}Add Card - eBay Card Sales{% endblock %}

{% block content %}
<h1>Add New Card</h1>

<form method="post" class="card-form">
    <div class="form-group">
        <label for="card_type">Card Type</label>
        <select name="card_type" id="card_type" required onchange="updateConditionOptions()">
            <option value="">-- Select --</option>
            <option value="sports">Sports Card</option>
            <option value="mtg">Magic: The Gathering</option>
            <option value="pokemon">Pokemon</option>
        </select>
    </div>

    <div class="form-row">
        <div class="form-group">
            <label for="set_name">Set / Product</label>
            <input type="text" name="set_name" id="set_name">
        </div>
        <div class="form-group" id="card_number_group">
            <label for="card_number">Card Number</label>
            <input type="text" name="card_number" id="card_number">
        </div>
    </div>

    <div class="form-group tcg-only" style="display:none">
        <label for="foil">Foil</label>
        <select name="foil" id="foil">
            <option value="non-foil">Non-Foil</option>
            <option value="foil">Foil</option>
        </select>
    </div>

    <div class="form-row sports-only" style="display:none">
        <div class="form-group">
            <label for="player_name">Player Name</label>
            <input type="text" name="player_name" id="player_name">
        </div>
        <div class="form-group">
            <label for="year">Year</label>
            <input type="text" name="year" id="year">
        </div>
    </div>

    <div class="form-group">
        <label>
            <input type="checkbox" name="is_graded" id="is_graded" onchange="toggleGraded()">
            This is a graded card
        </label>
    </div>

    <div class="graded-options" style="display:none">
        <div class="form-row">
            <div class="form-group">
                <label for="grading_company">Grading Company</label>
                <select name="grading_company" id="grading_company">
                    <option value="PSA">PSA</option>
                    <option value="BGS">BGS</option>
                    <option value="SGC">SGC</option>
                    <option value="CGC">CGC</option>
                </select>
            </div>
            <div class="form-group">
                <label for="grade">Grade</label>
                <input type="text" name="grade" id="grade">
            </div>
        </div>
    </div>

    <div class="raw-condition">
        <div class="form-group">
            <label for="condition">Condition</label>
            <select name="condition" id="condition">
                <!-- Options updated by JavaScript based on card type -->
                <option value="NM">Near Mint (NM)</option>
                <option value="LP">Lightly Played (LP)</option>
                <option value="MP">Moderately Played (MP)</option>
                <option value="HP">Heavily Played (HP)</option>
                <option value="DMG">Damaged (DMG)</option>
            </select>
        </div>
    </div>

    <div class="form-row">
        <div class="form-group">
            <label for="quantity">Quantity</label>
            <select name="quantity" id="quantity">
                <option value="1">1x</option>
                <option value="2">2x</option>
                <option value="3">3x</option>
                <option value="4">4x</option>
            </select>
        </div>
        <div class="form-group">
            <label for="starting_bid">Starting Bid ($)</label>
            <input type="number" name="starting_bid" id="starting_bid" value="0.50" min="0.01" step="0.01">
        </div>
    </div>

    <div class="form-group">
        <label for="name">Additional Details</label>
        <input type="text" name="name" id="name">
    </div>

    <div class="form-group">
        <label for="notes">Public Notes</label>
        <textarea name="notes" id="notes" rows="2"></textarea>
    </div>

    <div class="form-group">
        <label for="private_notes">Private Notes</label>
        <textarea name="private_notes" id="private_notes" rows="2"></textarea>
    </div>

    <div class="image-upload-section">
        <h3>Card Images</h3>

        <div class="image-upload-row">
            <div class="image-upload-box" id="front-upload-box">
                <label>Front of Card</label>
                <input type="file" id="image_front_file" accept=".jpg,.jpeg,.png,.tif,.tiff">
                <input type="hidden" name="image_front" id="image_front">
                <div class="upload-buttons">
                    <button type="button" class="btn btn-small" onclick="uploadImage('front', false)">Upload</button>
                    <button type="button" class="btn btn-small btn-primary" onclick="uploadImage('front', true)">Upload & Check Condition</button>
                </div>
                <div class="upload-status" id="front-status"></div>
                <div class="condition-result" id="front-condition"></div>
            </div>

            <div class="image-upload-box" id="back-upload-box">
                <label>Back of Card</label>
                <input type="file" id="image_back_file" accept=".jpg,.jpeg,.png,.tif,.tiff">
                <input type="hidden" name="image_back" id="image_back">
                <div class="upload-buttons">
                    <button type="button" class="btn btn-small" onclick="uploadImage('back', false)">Upload</button>
                    <button type="button" class="btn btn-small btn-primary" onclick="uploadImage('back', true)">Upload & Check Condition</button>
                </div>
                <div class="upload-status" id="back-status"></div>
                <div class="condition-result" id="back-condition"></div>
            </div>
        </div>
    </div>

    <div class="form-actions">
        <button type="submit" class="btn btn-primary">Add Card</button>
        <a href="{{ url_for('list_cards') }}" class="btn">Cancel</a>
    </div>
</form>

<script>
function updateConditionOptions() {
    const cardType = document.getElementById('card_type').value;
    const conditionSelect = document.getElementById('condition');
    const sportsOnlyFields = document.querySelectorAll('.sports-only');
    const tcgOnlyFields = document.querySelectorAll('.tcg-only');
    const cardNumberGroup = document.getElementById('card_number_group');

    // Show/hide sports-specific fields
    sportsOnlyFields.forEach(el => {
        el.style.display = cardType === 'sports' ? 'flex' : 'none';
    });

    // Show/hide TCG-specific fields (MTG and Pokemon)
    tcgOnlyFields.forEach(el => {
        el.style.display = (cardType === 'mtg' || cardType === 'pokemon') ? 'block' : 'none';
    });

    // Hide card number field for MTG
    cardNumberGroup.style.display = cardType === 'mtg' ? 'none' : 'block';

    // Update condition options based on card type
    if (cardType === 'sports') {
        conditionSelect.innerHTML = `
            <option value="NM">Near Mint (NM)</option>
            <option value="EX">Excellent (EX)</option>
            <option value="VG">Very Good (VG)</option>
            <option value="G">Good (G)</option>
            <option value="P">Poor (P)</option>
        `;
    } else {
        conditionSelect.innerHTML = `
            <option value="NM">Near Mint (NM)</option>
            <option value="LP">Lightly Played (LP)</option>
            <option value="MP">Moderately Played (MP)</option>
            <option value="HP">Heavily Played (HP)</option>
            <option value="DMG">Damaged (DMG)</option>
        `;
    }
}

function toggleGraded() {
    const isGraded = document.getElementById('is_graded').checked;
    document.querySelector('.graded-options').style.display = isGraded ? 'block' : 'none';
    document.querySelector('.raw-condition').style.display = isGraded ? 'none' : 'block';
}

async function uploadImage(side, checkCondition) {
    const fileInput = document.getElementById(`image_${side}_file`);
    const statusDiv = document.getElementById(`${side}-status`);
    const conditionDiv = document.getElementById(`${side}-condition`);
    const hiddenInput = document.getElementById(`image_${side}`);

    if (!fileInput.files[0]) {
        statusDiv.innerHTML = '<span class="error">Please select an image first</span>';
        return;
    }

    const formData = new FormData();
    formData.append('image', fileInput.files[0]);
    formData.append('side', side);
    formData.append('card_type', document.getElementById('card_type').value || 'trading card');

    if (checkCondition) {
        const conditionSelect = document.getElementById('condition');
        const isGraded = document.getElementById('is_graded').checked;
        let condition = '';
        if (isGraded) {
            const company = document.getElementById('grading_company').value;
            const grade = document.getElementById('grade').value;
            condition = `${company} ${grade}`;
        } else {
            condition = conditionSelect.value;
        }
        formData.append('condition', condition);
    }

    statusDiv.innerHTML = '<span class="loading">Uploading...</span>';
    conditionDiv.innerHTML = '';

    const endpoint = checkCondition ? '/api/check-condition' : '/api/upload-image';

    try {
        const response = await fetch(endpoint, {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (result.success) {
            hiddenInput.value = result.filename;
            statusDiv.innerHTML = '<span class="success">âœ“ Uploaded: ' + result.filename + '</span>';

            if (result.condition_check) {
                conditionDiv.innerHTML = '<div class="condition-assessment"><strong>Condition Assessment:</strong><br>' +
                    result.condition_check.replace(/\n/g, '<br>') + '</div>';
            } else if (result.warning) {
                conditionDiv.innerHTML = '<div class="condition-warning">' + result.warning + '</div>';
            } else if (result.error) {
                conditionDiv.innerHTML = '<div class="condition-error">' + result.error + '</div>';
            }
        } else {
            statusDiv.innerHTML = '<span class="error">Error: ' + result.error + '</span>';
        }
    } catch (err) {
        statusDiv.innerHTML = '<span class="error">Upload failed: ' + err.message + '</span>';
    }
}
</script>
{% endblock %}
